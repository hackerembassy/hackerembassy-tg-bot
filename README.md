# Hacker embassy бот
## About
Бот для решения различных спейсовских задач. Пока реализованы:
- Информация о спейсе, резиденстве, местоположении и приеме донатов
- Открытие и закрытие спейса, отмечание прихода ухода участников, отмечание кто собирается в спейс
- Управление сборами денег и донатами с генерацией csv и диаграмм, с конвертацией валют фиатов и крипты
- Управление вещами, которые нужно купить в спейс по дороге
- Управление пользователями и ролями
- Получение статуса 3d принтера (фото печатающейся модели, фото с камеры принтера, процент завершения печати, оставшееся время, потраченные расходники, температуры)
- Доступ к камерам наблюдения первого этажа и двери
- Открытие двери и включение дверного замка с уведомлением в чат и фото с камеры, если звонят тогда, когда в спейсе никого нет
- API некоторых команд для сайта спейса
- Глобальные модификаторы команд
- Кнопки быстрых inline-ответов
- Учет автоматического входа и ухода участников из спейса через wifi сеть
- Учет дней рождения и автопоздравление от бота в нужный день
- Уведомление резидентов об оплате коммуналки и интернета спейса в нужные дни
- Мем команды с рандомными фотками котиков, пёсиков и Каба

Для хранения данных используется база sqlite в файле ./data/data.db
Тестовый файл с верной схемой ./data/sample.db
Для редактирования базы вручную рекомендую https://sqlitebrowser.org/

Как reverse proxy для использования https и автоматического получения сертификатов используется веб-сервер Caddy. При разработке необязателен.

Роли пользователей: 
- admin - управляет пользователями
- accountant - управляет донатами и сборами
- member - резидент спейса, может открывать и закрывать спейс
- default - обычный гость, в базе данных присутствие необязательно
- Kitten - специальная роль для @keimoger. Даёт только иконку котика при всех упоминаниях. Не знаю зачем я это добавил

## Hosting
Сам бот хостится на VPS с адресом gateway.hackerembassy.site (поддерживает @tectonick).   
Сервис embassy-api хостится в спейсе компе blackbox под 3d принтером и обеспечивает связь с внутренней инфраструктурой спейса (3d принтер, роутер, камеры, звонок).  
По всем вопросам деплоя или токена тестового бота обращайтесь к @tectonick.   
Так же можете создать своего тестового бота с помощью BotFather в телеге.  

## TODO
- Взаимодействие с home assistant
- Взаимодействие с лазерным принтером
- Скрипты деплоя

## Dependencies
Все основные зависимости в облаке и внутреннем сервисе устанавливаются с помощью npm i
Для конвертации потока дверной камеры в jpg на сервисе бота нужно установить ffmpeg и прописать его в PATH.

## Local deployment:
1. Установите nodejs версии 18+
2. Перейдите в папку склонированного репозитория
3. Установите зависимости с командой  
        npm install
4. Подготовьте бот к первому запуску  
        npm run init
5. Установите env переменные (можно создать файл .env со следующим содержимым)  
        HACKERBOTTOKEN="Токен тестового бота из бота https://t.me/BotFather"
        BOTDEBUG="true"
6. Запустите бота в режиме автоматического перезапуска при изменении source кода  
        npm run dev

## Environment variables needed
HACKERBOTTOKEN
BOTDEBUG
LUCITOKEN
UNLOCKKEY
MQTTUSER
MQTTPASSWORD

## Additional notes
Для взаимодействия между ботом и сервисом понадобится добавить папку sec с rsa ключами в файлах pub.key и priv.key. 
Также переменная UNLOCKKEY должна совпадать на боте и на сервисе.  
Проверьте настройки портов в папке config. Для локальной разработки лучше создать свою конфигурацию в файле config/local.json  
Для старта сервиса вызывается node embassyApi.js  